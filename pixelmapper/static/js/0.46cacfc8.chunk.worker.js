!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/pixelmapper/",n(n.s=0)}([function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){return void 0!==e.x?{x:e.x-t.x,y:e.y-t.y}:e.map((function(e,n){return e-t[n]}))}function s(e){return void 0!==e.x?s([e.x,e.y]):Math.sqrt(e.reduce((function(e,t){return e+t*t}),0))}n.r(t);var l={thresholdStep:10,minThreshold:50,maxThreshold:220,minRepeatability:2,minDistBetweenBlobs:10,filterByColor:!0,blobColor:0,filterByArea:!0,minArea:25,maxArea:5e3,filterByCircularity:!1,minCircularity:.8,maxCircularity:1e6,filterByInertia:!0,minInertiaRatio:.1,maxInertiaRatio:1e6,filterByConvexity:!0,minConvexity:.95,maxConvexity:1e6,faster:!1};function u(e,t,n){var i=new cv.MatVector,r=new cv.Mat;n.faster?cv.findContours(t,i,r,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE):cv.findContours(t,i,r,cv.RETR_LIST,cv.CHAIN_APPROX_NONE),r.delete();for(var o=[],a=[],l=0;l<i.size();l++){var u=i.get(l);a.push(u);var d=cv.contourArea(u);if(0!=d){var v=void 0,f=void 0;if(n.faster){var m=cv.boundingRect(u),h=m.x,g=m.y,p=m.width,y=m.height;v={confidence:1,location:{x:h+p/2,y:g+y/2},radius:(p+y)/4}}else v={confidence:1,location:{x:(f=cv.moments(u)).m10/f.m00,y:f.m01/f.m00}};if(!n.filterByArea||!(d<n.minArea||d>=n.maxArea)){if(n.filterByCircularity){var C=cv.arcLength(u,!0),x=4*cv.CV_PI*d/(C*C);if(x<n.minCircularity||x>=n.maxCircularity)continue}if(n.filterByInertia){if(n.faster)throw new Error("Cannot both set params.faster and params.filterByInertia");var b=Math.sqrt(Math.pow(2*f.mu11,2)+Math.pow(f.mu20-f.mu02,2)),I=void 0;if(b>.01){var w=(f.mu20-f.mu02)/b,P=2*f.mu11/b,M=-w,S=-P;I=(.5*(f.mu20+f.mu02)-.5*(f.mu20-f.mu02)*w-f.mu11*P)/(.5*(f.mu20+f.mu02)-.5*(f.mu20-f.mu02)*M-f.mu11*S)}else I=1;if(I<n.minInertiaRatio||I>=n.maxInertiaRatio)continue;v.confidence=I*I}if(n.filterByConvexity){var _=new cv.Mat;cv.convexHull(u,_);var R=d/cv.contourArea(_);if(_.delete(),R<n.minConvexity||R>=n.maxConvexity)continue}if(!n.filterByColor||t.ucharAt(Math.round(v.location.y),Math.round(v.location.x))==n.blobColor){if(!n.faster){for(var O=[],B=0;B<u.size().height;B++){var E=u.intPtr(B);O.push(s(c(v.location,{x:E[0],y:E[1]})))}O.sort(),v.radius=(O[Math.floor((O.length-1)/2)]+O[Math.floor(O.length/2)])/2}o.push(v)}}}}return a.forEach((function(e){return e.delete()})),i.delete(),o}var d,v=function e(t){var n=this;i(this,e),this.numPixels=t,this.codeLength=void 0,this.Encode=function(e){return e},this.Decode=function(e){if(!(e<0||e>=n.numPixels))return e},this.GetCodeLength=function(){return n.codeLength},this.GetHighestCode=function(){return n.numPixels},this.codeLength=Math.ceil(Math.log(this.numPixels)/Math.log(2))},f=function e(t){var n=this;i(this,e),this.numPixels=t,this.codeLength=void 0,this.codes={},this.decodes={},this.Encode=function(e){return n.codes[e]},this.Decode=function(e){return n.decodes[e]},this.GetCodeLength=function(){return n.codeLength},this.GetHighestCode=function(){return n.codes[n.numPixels-1]},this.calcCodeLength=function(){for(var e=2;n.nCr(e,e/2)<n.numPixels;)e+=2;return e},this.nCr=function(e,t){return e===t?1:(t=t<e-t?e-t:t,n.factorialRange(t+1,e)/n.factorialRange(1,e-t))},this.factorialRange=function(e,t){for(var n=e,i=e;i++<t;)n*=i;return n},this.isBalanced=function(e){return n.bitCount(e)===n.codeLength/2},this.bitCount=function(e){return 16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24},this.generateCodes=function(){for(var e=0,t=0;e<n.numPixels;)n.isBalanced(t)&&(n.codes[e]=t,n.decodes[t]=e,e++),t++},this.codeLength=this.calcCodeLength(),this.generateCodes()};!function(e){e.Binary="Binary",e.Balanced="Balanced"}(d||(d={}));self.importScripts("".concat("/pixelmapper","/opencv.js"));var m=new function e(t){var n=this;i(this,e),this.codedImage=[],this.codedImageNegative=[],this.initialized=!1,this.numSlices=0,this.numPixels=0,this.config={blur:11,align:!0,imgWidth:1280,livePreview:!0,connectPoints:!0,labelPoints:!0},this.init=function(e,t,i,r,o){if(n.initialized=!0,console.log("initializing mapper",{numPixels:r,encoderType:o}),n.sendStatus("Initializing"),n.encoder=function(e,t){switch(e){case d.Balanced:return new f(t);case d.Binary:default:return new v(t)}}(o,r),n.numPixels=r,n.numSlices=i.length,n.numSlices!==n.encoder.GetCodeLength())throw Error("number of images does not match encoder code length");var a=void 0;t&&(n.sendStatus("Preparing black image"),a=n.prepareImage(t,void 0,void 0,!1)),n.sendStatus("Preparing start image"),n.startImage=n.prepareImage(e,a,void 0,!0),n.sendStatus("Processing slice images"),n.codedImage=[],n.codedImageNegative=[],i.forEach((function(e){var t=n.prepareImage(e,a,n.startImage,!0);n.codedImage.push(t),n.codedImageNegative.push(n.invertColors(t))})),t.delete(),e.delete(),i.forEach((function(e){return e.delete()})),a.delete()},this.run=function(){n.sendStatus("Decoding positions"),n.decodeRecursive(n.startImage,0,n.numSlices),n.listener({type:"DONE"})},this.clean=function(){n.startImage.delete(),n.codedImage.forEach((function(e){return e.delete()})),n.codedImageNegative.forEach((function(e){return e.delete()})),n.initialized=!1},this.sendStatus=function(e){console.log(e),n.listener({type:"STATUS",msg:e})},this.decodeRecursive=function(e,t,i){if(0===i){var r=n.encoder.Decode(t);void 0!==r&&r>=0&&r<n.numPixels&&n.detectSinglePixel(e,r,t)}else{var o=new cv.Mat(e.size(),cv.CV_32F),a=new cv.Mat(e.size(),cv.CV_32F);cv.multiply(e,n.codedImage[i-1],o),cv.multiply(e,n.codedImageNegative[i-1],a),t<<1<=n.encoder.GetHighestCode()&&(n.decodeRecursive(a,t<<1,i-1),n.decodeRecursive(o,t<<1|1,i-1)),o.delete(),a.delete()}},this.detectParams={thresholdStep:64,minThreshold:64,maxThreshold:255,minDistBetweenBlobs:10,filterByColor:!1,filterByArea:!1,filterByInertia:!1,filterByConvexity:!1,minRepeatability:1,minArea:2,maxArea:500,faster:!0},this.detectSinglePixel=function(e,t,i){var r=cv.minMaxLoc(e).maxVal;e.convertTo(e,cv.CV_32FC1,1/r);var o=function(e,t){t=a(a({},l),t);var n=new cv.Mat(e.rows,e.cols,cv.CV_8UC1);e.type()===cv.CV_32FC1?e.convertTo(n,cv.CV_8UC1,255):cv.cvtColor(e,n,cv.COLOR_RGB2GRAY);for(var i=[],r=t.minThreshold;r<t.maxThreshold;r+=t.thresholdStep){var o=new cv.Mat(e.rows,e.cols,cv.CV_8UC1);cv.threshold(n,o,r,255,cv.THRESH_BINARY);var d=u(0,o,t);o.delete();for(var v=[],f=0;f<d.length;f++){for(var m=!0,h=0;h<i.length;h++){var g=s(c(i[h][Math.floor(i[h].length/2)].location,d[f].location));if(!(m=g>=t.minDistBetweenBlobs&&g>=i[h][Math.floor(i[h].length/2)].radius&&g>=d[f].radius)){i[h].push(d[f]);for(var p=i[h].length-1;p>0&&i[h][p].radius<i[h][p-1].radius;)i[h][p]=i[h][p-1],p--;i[h][p]=d[f];break}}m&&v.push([d[f]])}i=i.concat(v)}n.delete();for(var y=[],C=0;C<i.length;C++)if(!(i[C].length<t.minRepeatability)){for(var x={x:0,y:0},b=0,I=0;I<i[C].length;I++)x.x+=i[C][I].confidence*i[C][I].location.x,x.y+=i[C][I].confidence*i[C][I].location.y,b+=i[C][I].confidence;x.x*=1/b,x.y*=1/b;var w=Math.round(2*i[C][Math.floor(i[C].length/2)].radius);w=Math.min(w,2*x.x,2*x.y,2*(e.cols-x.x),2*(e.rows-x.y)),y.push({pt:x,size:w})}return y}(e,n.detectParams).map((function(t){return{x:t.pt.x,y:t.pt.y,size:t.size,intensity:e.floatAt(Math.round(t.pt.y),Math.round(t.pt.x))*r}}));o.sort((function(e,t){return t.intensity-e.intensity})),o.length<=3&&o.forEach((function(e){return e.intensity=Math.min(1,2*e.intensity)})),1==o.length&&o.forEach((function(e){return e.intensity=Math.min(1,2*e.intensity)}));var d=o&&o[0]&&o[0].intensity>=.01?o[0]:void 0,v={type:"PIXELRESULT",index:t,code:i,isLocated:o.length>0,position:d,alternativePositions:o};n.listener(v)},this.recalculate=function(e,t){for(var i=n.startImage.clone(),r=0;r<n.numSlices;r++){e>>r&1?cv.multiply(i,n.codedImage[r],i):cv.multiply(i,n.codedImageNegative[r],i)}var o=cv.minMaxLoc(i).maxVal;i.convertTo(i,cv.CV_32FC1,1/o),n.listener({type:"RECALCULATEIMG",img:i,code:e,index:t}),i.delete()},this.debug=function(e,t){n.listener({type:"DEBUGIMG",img:e,msg:t})},this.invertColors=function(e){var t=cv.Mat.ones(e.size(),cv.CV_32F);return cv.subtract(t,e,t),t},this.prepareImage=function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=new cv.Mat(e.size(),cv.CV_32F);return e.convertTo(o,cv.CV_32F),cv.cvtColor(o,o,cv.COLOR_RGB2GRAY),o=n.rescaleSize(o),n.config.blur>0&&cv.GaussianBlur(o,o,new cv.Size(n.config.blur,n.config.blur),0,0),t&&cv.subtract(o,t,o),r&&cv.divide(o,cv.Mat.ones(o.size(),cv.CV_32F),o,1/256),t&&(o.convertTo(o,-1,2.2,-.25),cv.max(o,cv.Mat.zeros(o.size(),cv.CV_32F),o),cv.min(o,cv.Mat.ones(o.size(),cv.CV_32F),o)),o},this.rescaleSize=function(e){var t=e.size();if(t.width<=n.config.imgWidth)return e;var i=n.config.imgWidth,r=Math.round(t.height*(n.config.imgWidth/t.width)),o=new cv.Mat(r,i,cv.CV_32F);return cv.resize(e,o,o.size()),e.delete(),o},this.listener=t,console.log("Pixelmapper constructor")}((function(e){e.img&&(e.img=function(e){if(e.type===cv.CV_32FC1){console.log("special type:",e.type(),cv.CV_32FC1);var t=new cv.Mat;e.convertTo(t,cv.CV_8U,255,0);var n=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),n}var i=new cv.Mat,r=e.type()%8,o=r<=cv.CV_8S?1:r<=cv.CV_32S?1/256:255,a=r===cv.CV_8S||r===cv.CV_16S?128:0;switch(e.convertTo(i,cv.CV_8U,o,a),i.type()){case cv.CV_8UC1:cv.cvtColor(i,i,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(i,i,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}var c=new ImageData(new Uint8ClampedArray(i.data),i.cols,i.rows);return i.delete(),c}(e.img)),postMessage(e)}));addEventListener("message",(function(e){var t=e.data;switch(t.type){case"RUN":m.init(cv.matFromImageData(t.whiteImage),cv.matFromImageData(t.blackImage),t.sliceImages.map((function(e){return cv.matFromImageData(e)})),t.numPixels,t.encoderType),m.run();break;case"RECALCULATE":m.recalculate(t.code,t.index);break;case"CLEAN":m.clean();break;case"ISINITIALIZEDREQUEST":postMessage({type:"ISINITIALIZEDRESPONSE",initialized:m.initialized});break;case"INITONLY":m.init(cv.matFromImageData(t.whiteImage),cv.matFromImageData(t.blackImage),t.sliceImages.map((function(e){return cv.matFromImageData(e)})),t.numPixels,t.encoderType)}}))}]);