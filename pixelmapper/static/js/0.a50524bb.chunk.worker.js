!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/pixelmapper/",n(n.s=0)}([function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.r(t);var r,a=function e(t){var n=this;i(this,e),this.numPixels=t,this.codeLength=void 0,this.Encode=function(e){return e},this.Decode=function(e){if(!(e<0||e>=n.numPixels))return e},this.GetCodeLength=function(){return n.codeLength},this.GetHighestCode=function(){return n.numPixels},this.codeLength=Math.ceil(Math.log(this.numPixels)/Math.log(2))},o=function e(t){var n=this;i(this,e),this.numPixels=t,this.codeLength=void 0,this.codes={},this.decodes={},this.Encode=function(e){return n.codes[e]},this.Decode=function(e){return n.decodes[e]},this.GetCodeLength=function(){return n.codeLength},this.GetHighestCode=function(){return n.codes[n.numPixels-1]},this.calcCodeLength=function(){for(var e=2;n.nCr(e,e/2)<n.numPixels;)e+=2;return e},this.nCr=function(e,t){return e===t?1:(t=t<e-t?e-t:t,n.factorialRange(t+1,e)/n.factorialRange(1,e-t))},this.factorialRange=function(e,t){for(var n=e,i=e;i++<t;)n*=i;return n},this.isBalanced=function(e){return n.bitCount(e)===n.codeLength/2},this.bitCount=function(e){return 16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24},this.generateCodes=function(){for(var e=0,t=0;e<n.numPixels;)n.isBalanced(t)&&(n.codes[e]=t,n.decodes[t]=e,e++),t++},this.codeLength=this.calcCodeLength(),this.generateCodes()};!function(e){e.Binary="Binary",e.Balanced="Balanced"}(r||(r={}));var c=function(e){if(e.type===cv.CV_32FC1){console.log("special type:",e.type(),cv.CV_32FC1);var t=new cv.Mat;e.convertTo(t,cv.CV_8U,255,0);var n=new ImageData(new Uint8ClampedArray(t.data),t.cols,t.rows);return t.delete(),n}var i=new cv.Mat,r=e.type()%8,a=r<=cv.CV_8S?1:r<=cv.CV_32S?1/256:255,o=r===cv.CV_8S||r===cv.CV_16S?128:0;switch(e.convertTo(i,cv.CV_8U,a,o),i.type()){case cv.CV_8UC1:cv.cvtColor(i,i,cv.COLOR_GRAY2RGBA);break;case cv.CV_8UC3:cv.cvtColor(i,i,cv.COLOR_RGB2RGBA);break;case cv.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}var c=new ImageData(new Uint8ClampedArray(i.data),i.cols,i.rows);return i.delete(),c};function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var d=function(e,t){return{x:e.x-t.x,y:e.y-t.y}},v=function(e){return Math.sqrt([e.x,e.y].reduce((function(e,t){return e+t*t}),0))},f={thresholdStep:10,minThreshold:50,maxThreshold:220,minRepeatability:2,minDistBetweenBlobs:10,filterByColor:!0,blobColor:0,filterByArea:!0,minArea:25,maxArea:5e3,filterByCircularity:!1,minCircularity:.8,maxCircularity:1e6,filterByInertia:!0,minInertiaRatio:.1,maxInertiaRatio:1e6,filterByConvexity:!0,minConvexity:.95,maxConvexity:1e6,faster:!1};function m(e,t,n){var i=new cv.MatVector,r=new cv.Mat;n.faster?cv.findContours(t,i,r,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE):cv.findContours(t,i,r,cv.RETR_LIST,cv.CHAIN_APPROX_NONE),r.delete();for(var a=[],o=[],c=0;c<i.size();c++){var s=i.get(c);o.push(s);var l=cv.contourArea(s);if(0!=l){var u=void 0,f=void 0;if(n.faster){var m=cv.boundingRect(s),h=m.x,g=m.y,p=m.width,y=m.height;u={confidence:1,location:{x:h+p/2,y:g+y/2},radius:(p+y)/4}}else u={confidence:1,location:{x:(f=cv.moments(s)).m10/f.m00,y:f.m01/f.m00}};if(!n.filterByArea||!(l<n.minArea||l>=n.maxArea)){if(n.filterByCircularity){var C=cv.arcLength(s,!0),b=4*cv.CV_PI*l/(C*C);if(b<n.minCircularity||b>=n.maxCircularity)continue}if(n.filterByInertia){if(n.faster)throw new Error("Cannot both set params.faster and params.filterByInertia");var x=Math.sqrt(Math.pow(2*f.mu11,2)+Math.pow(f.mu20-f.mu02,2)),I=void 0;if(x>.01){var w=(f.mu20-f.mu02)/x,P=2*f.mu11/x,M=-w,S=-P;I=(.5*(f.mu20+f.mu02)-.5*(f.mu20-f.mu02)*w-f.mu11*P)/(.5*(f.mu20+f.mu02)-.5*(f.mu20-f.mu02)*M-f.mu11*S)}else I=1;if(I<n.minInertiaRatio||I>=n.maxInertiaRatio)continue;u.confidence=I*I}if(n.filterByConvexity){var _=new cv.Mat;cv.convexHull(s,_);var R=l/cv.contourArea(_);if(_.delete(),R<n.minConvexity||R>=n.maxConvexity)continue}if(!n.filterByColor||t.ucharAt(Math.round(u.location.y),Math.round(u.location.x))==n.blobColor){if(!n.faster){for(var O=[],B=0;B<s.size().height;B++){var E=s.intPtr(B);O.push(v(d(u.location,{x:E[0],y:E[1]})))}O.sort(),u.radius=(O[Math.floor((O.length-1)/2)]+O[Math.floor(O.length/2)])/2}a.push(u)}}}}return o.forEach((function(e){return e.delete()})),i.delete(),a}var h=self;h.importScripts("".concat("/pixelmapper","/opencv.js"));var g=function(e){return h.postMessage(e)},p=new function e(t){var n=this;i(this,e),this.callback=t,this.codedImage=[],this.codedImageNegative=[],this.startImage=void 0,this.encoder=void 0,this.initialized=!1,this.numSlices=0,this.numPixels=0,this.config={blur:11,align:!0,imgWidth:1280,livePreview:!0,connectPoints:!0,labelPoints:!0},this.init=function(e,t,i,c,s){var l;if(n.initialized=!0,console.log("initializing mapper",{numPixels:c,encoderType:s}),n.sendStatus("Initializing"),n.encoder=function(e,t){switch(e){case r.Balanced:return new o(t);case r.Binary:default:return new a(t)}}(s,c),n.numPixels=c,n.numSlices=i.length,n.numSlices!==n.encoder.GetCodeLength())throw Error("number of images does not match encoder code length");var u=void 0;t&&(n.sendStatus("Preparing black image"),u=n.prepareImage(t,void 0,void 0,!1)),n.sendStatus("Preparing start image"),n.startImage=n.prepareImage(e,u,void 0,!0),n.sendStatus("Processing slice images"),n.codedImage=[],n.codedImageNegative=[],i.forEach((function(e){var t=n.prepareImage(e,u,n.startImage,!0);n.codedImage.push(t),n.codedImageNegative.push(n.invertColors(t))})),t.delete(),e.delete(),i.forEach((function(e){return e.delete()})),null===(l=u)||void 0===l||l.delete()},this.run=function(){if(!n.initialized||!n.startImage)throw Error("Must initialize before decoding");n.sendStatus("Decoding positions"),n.decodeRecursive(n.startImage,0,n.numSlices),n.callback({type:"DONE"})},this.clean=function(){var e;null===(e=n.startImage)||void 0===e||e.delete(),n.codedImage.forEach((function(e){return e.delete()})),n.codedImageNegative.forEach((function(e){return e.delete()})),n.initialized=!1},this.sendStatus=function(e){console.log(e),n.callback({type:"STATUS",msg:e})},this.decodeRecursive=function(e,t,i){if(0===i){var r=n.encoder.Decode(t);void 0!==r&&r>=0&&r<n.numPixels&&n.detectSinglePixel(e,r,t)}else{var a=new cv.Mat(e.size(),cv.CV_32F),o=new cv.Mat(e.size(),cv.CV_32F);cv.multiply(e,n.codedImage[i-1],a),cv.multiply(e,n.codedImageNegative[i-1],o),t<<1<=n.encoder.GetHighestCode()&&(n.decodeRecursive(o,t<<1,i-1),n.decodeRecursive(a,t<<1|1,i-1)),a.delete(),o.delete()}},this.detectParams={thresholdStep:64,minThreshold:64,maxThreshold:255,minDistBetweenBlobs:10,filterByColor:!1,filterByArea:!1,filterByInertia:!1,filterByConvexity:!1,minRepeatability:1,minArea:2,maxArea:500,faster:!0},this.detectSinglePixel=function(e,t,i){var r=cv.minMaxLoc(e).maxVal;e.convertTo(e,cv.CV_32FC1,1/r);var a=function(e,t){t=u(u({},f),t);var n=new cv.Mat(e.rows,e.cols,cv.CV_8UC1);e.type()===cv.CV_32FC1?e.convertTo(n,cv.CV_8UC1,255):cv.cvtColor(e,n,cv.COLOR_RGB2GRAY);for(var i=[],r=t.minThreshold;r<t.maxThreshold;r+=t.thresholdStep){var a=new cv.Mat(e.rows,e.cols,cv.CV_8UC1);cv.threshold(n,a,r,255,cv.THRESH_BINARY);var o=m(0,a,t);a.delete();for(var c=[],s=0;s<o.length;s++){for(var l=!0,h=0;h<i.length;h++){var g,p,y=v(d(i[h][Math.floor(i[h].length/2)].location,o[s].location));if(!(l=y>=t.minDistBetweenBlobs&&y>=(null!==(g=i[h][Math.floor(i[h].length/2)].radius)&&void 0!==g?g:0)&&y>=(null!==(p=o[s].radius)&&void 0!==p?p:0))){i[h].push(o[s]);for(var C=i[h].length-1;C>0&&(null!==(b=i[h][C].radius)&&void 0!==b?b:0)<(null!==(x=i[h][C-1].radius)&&void 0!==x?x:0);){var b,x;i[h][C]=i[h][C-1],C--}i[h][C]=o[s];break}}l&&c.push([o[s]])}i=i.concat(c)}n.delete();for(var I=[],w=0;w<i.length;w++){var P;if(!(i[w].length<t.minRepeatability)){for(var M={x:0,y:0},S=0,_=0;_<i[w].length;_++)M.x+=i[w][_].confidence*i[w][_].location.x,M.y+=i[w][_].confidence*i[w][_].location.y,S+=i[w][_].confidence;M.x*=1/S,M.y*=1/S;var R=Math.round(2*(null!==(P=i[w][Math.floor(i[w].length/2)].radius)&&void 0!==P?P:0));R=Math.min(R,2*M.x,2*M.y,2*(e.cols-M.x),2*(e.rows-M.y)),I.push({pt:M,size:R})}}return I}(e,n.detectParams).map((function(t){return{x:t.pt.x,y:t.pt.y,size:t.size,confidence:e.floatAt(Math.round(t.pt.y),Math.round(t.pt.x))*r}}));a.sort((function(e,t){return t.confidence-e.confidence})),a.length<=3&&a.forEach((function(e){return e.confidence=Math.min(1,2*e.confidence)})),1==a.length&&a.forEach((function(e){return e.confidence=Math.min(1,2*e.confidence)}));var o=a&&a[0]&&a[0].confidence>=.01?a[0]:void 0;n.callback({type:"PIXELRESULT",index:t,code:i,position:o,alternativePositions:a})},this.recalculate=function(e,t){if(n.initialized&&n.startImage){for(var i=n.startImage.clone(),r=0;r<n.numSlices;r++){e>>r&1?cv.multiply(i,n.codedImage[r],i):cv.multiply(i,n.codedImageNegative[r],i)}var a=cv.minMaxLoc(i).maxVal;i.convertTo(i,cv.CV_32FC1,1/a),n.callback({type:"RECALCULATEIMG",img:c(i),code:e,index:t}),i.delete()}},this.debug=function(e,t){n.callback({type:"DEBUGIMG",img:c(e),msg:t})},this.invertColors=function(e){var t=cv.Mat.ones(e.size(),cv.CV_32F);return cv.subtract(t,e,t),t},this.prepareImage=function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=new cv.Mat(e.size(),cv.CV_32F);return e.convertTo(a,cv.CV_32F),cv.cvtColor(a,a,cv.COLOR_RGB2GRAY),a=n.rescaleSize(a),n.config.blur>0&&cv.GaussianBlur(a,a,new cv.Size(n.config.blur,n.config.blur),0,0),t&&cv.subtract(a,t,a),r&&cv.divide(a,cv.Mat.ones(a.size(),cv.CV_32F),a,1/256),t&&(a.convertTo(a,-1,2.2,-.25),cv.max(a,cv.Mat.zeros(a.size(),cv.CV_32F),a),cv.min(a,cv.Mat.ones(a.size(),cv.CV_32F),a)),a},this.rescaleSize=function(e){var t=e.size();if(t.width<=n.config.imgWidth)return e;var i=n.config.imgWidth,r=Math.round(t.height*(n.config.imgWidth/t.width)),a=new cv.Mat(r,i,cv.CV_32F);return cv.resize(e,a,a.size()),e.delete(),a},console.log("Pixelmapper constructor")}(g);h.addEventListener("message",(function(e){var t=e.data;switch(t.type){case"RUN":p.init(cv.matFromImageData(t.whiteImage),cv.matFromImageData(t.blackImage),t.sliceImages.map((function(e){return cv.matFromImageData(e)})),t.numPixels,t.encoderType),p.run();break;case"RECALCULATE":p.recalculate(t.code,t.index);break;case"CLEAN":p.clean();break;case"ISINITIALIZEDREQUEST":g({type:"ISINITIALIZEDRESPONSE",initialized:p.initialized});break;case"INITONLY":p.init(cv.matFromImageData(t.whiteImage),cv.matFromImageData(t.blackImage),t.sliceImages.map((function(e){return cv.matFromImageData(e)})),t.numPixels,t.encoderType)}}))}]);